(function(factory){if(typeof define==='function'&&define.amd){define(['jquery'],factory)}else{factory(jQuery)}}(function($){var laziestLoader=function(options,callback){var $w=$(window),$elements=this,$loaded=$(),retina=window.devicePixelRatio>1,didScroll=!1;options=$.extend(!0,{threshold:0,sizePattern:/{{SIZE}}/ig,getSource:getSource,event:'scroll',scrollThrottle:250,sizeOffsetPercent:0,setSourceMode:!0},options);var useNativeScroll=(typeof options.event==='string')&&(options.event.indexOf('scroll')===0);function getSource($el){var source,slug;var data=$el.data();if(data.pattern&&data.widths&&$.isArray(data.widths)){source=retina?data.patternRetina:data.pattern;source=source||data.pattern;if(typeof data.widths[0]==='object'){slug=(function(){var widths=$.map(data.widths,function(val){return val.size});var bestFitWidth=bestFit($el.width(),widths);for(var i=data.widths.length-1;i>=0;i--){if(data.widths[i].size===bestFitWidth){return data.widths[i].slug}}})();source=source.replace(options.sizePattern,slug)}else{source=source.replace(options.sizePattern,bestFit($el.width(),data.widths))}}else{source=retina?data.srcRetina:data.src;source=source||data.src}
	return source}
	function onLoad($el){$el.addClass('ll-loaded').removeClass('ll-notloaded');$el.trigger('loaded');if(typeof callback==='function'){callback.call($el)}}
	function bindLoader(){$elements.one('laziestloader',function(){var $el=$(this);var source;if($el.data().ratio){setHeight.call(this)}
		if(options.setSourceMode){source=options.getSource($el);if(source&&this.getAttribute('src')!==source){this.setAttribute('src',source)}}
		$el.addClass('ll-loadstarted');if(options.setSourceMode&&(this.nodeName==='IMG'||this.nodeName==='VIDEO'||this.nodeName==='AUDIO')){if(this.nodeName==='IMG'){this.onload=function(){onLoad($el)}}else{this.onloadstart=function(){onLoad($el)}}}else{onLoad($el)}})}
	function unbindLoader(){$elements.off('laziestloader')}
	var bestFit=laziestLoader.bestFit=function(targetWidth,widths){var selectedWidth=widths[widths.length-1],i=widths.length,offset=targetWidth*(options.sizeOffsetPercent/100);widths.sort(function(a,b){return a-b});while(i--){if((targetWidth-offset)<=widths[i]){selectedWidth=widths[i]}}
		return selectedWidth};function laziestloader(){var docEl=document.documentElement;var wHeight=window.innerHeight||docEl.clientHeight;var wWidth=window.innerWidth||docEl.clientWidth;var threshold=options.threshold;var $inview=$elements.not($loaded).filter(function(){if($(this).is(':hidden'))return;var rect=$(this)[0].getBoundingClientRect();return(rect.bottom+threshold>0&&rect.right+threshold>0&&rect.left<wWidth+threshold&&rect.top<wHeight+threshold)});$inview.trigger('laziestloader');$loaded.add($inview)}
	function setHeight(){var $el=$(this),data=$el.data();data.ratio=data.ratio||data.heightMultiplier;if(data.ratio){$el.css({height:Math.round($el.width()*data.ratio)})}}
	$elements.addClass('ll-init ll-notloaded').each(setHeight);bindLoader();if(useNativeScroll){$w.scroll(function(){didScroll=!0});setInterval(function(){if(didScroll){didScroll=!1;laziestloader()}},options.scrollThrottle)}else{if(typeof options.event==='function'){options.event(laziestloader)}else{$w.on(options.event,function(){laziestloader()})}}
	$w.resize(function(){$loaded=$();unbindLoader();bindLoader();laziestloader()});$(document).ready(function(){laziestloader()});return this};$.fn.laziestloader=laziestLoader}))
