function logMessage(e){window.location.search.match(/gtm_debug=true/)&&console.log("logMessage:",e)}function SquaredPaywall(e,t){function o(e,t){R.each(e.split(/\s+/),function(e,o){"undefined"==typeof $[o]&&($[o]=[]),$[o].push(t)})}function n(e,t){R.each(e.split(/\s+/),function(e,o){if("undefined"!=typeof $[o])for(var n=0;n<$[o].length;)t===$[o][n]?$[o].splice(n,1):n++})}function a(e){R.each(e.split(/\s+/),function(e,t){"undefined"!=typeof $[t]&&($[t]=[])})}function i(e,t){t=t||[],R.each(e.split(/\s+/),function(e,o){"undefined"!=typeof $[o]&&R.each($[o],function(e,o){o.apply(O,t)})})}function r(t){e.email=t,F(function(){i("setemail",[t])})}function c(t){e.userRef=t,F(function(){i("setuserref",[t])})}function s(e){for(var t=1;t<arguments.length;t++)for(var o in arguments[t])"object"==typeof arguments[t][o]?e[o]=s(e[o],arguments[t][o]):e[o]=arguments[t][o];return e}function l(){if(e.entryId){var t=new Date;t.setYear(t.getUTCFullYear()+1),document.cookie="exp_squared_entry_id="+e.entryId+"; expires="+t.toGMTString()+"; path=/"}window.location.href="/squared/finish-registration"}function d(){return!!e.registrationComplete||(l(),!1)}function u(t,o){R.ajax({type:"POST",url:e.accessTestActionUrl,data:{ajax:1}}).done(function(e,n,a){"yes"===e?t.call(O):o.call(O)})}function f(){u(I,b)}function g(){u(I,M)}function p(){u(m,x)}function m(){F(function(){R("body").addClass("squared-enabled").removeClass("squared-prepared"),U(),x()})}function h(){F(function(){R("body").toggleClass("logged-in",e.loggedIn).toggleClass("logged-out",!e.loggedIn),y(e.loggedIn)})}function y(e){F(function(){R.cookie("gtm_auth",e?"yes":"no",{expires:1,path:"/"}),logMessage("setAuthCookie - setting gtm_auth: "+R.cookie("gtm_auth"))})}function q(e){F(function(){R.cookie("gtm_no_content",e?"yes":"no",{expires:1,path:"/"}),logMessage("setNoContentCookie - setting gtm_no_content: "+R.cookie("gtm_no_content"))})}function v(t){if(e.loggedIn){if("#checkout"===window.location.hash||t===!0)return void(d()&&f());if(e.existingSquaredUser)return void g()}M()}function k(){F(function(){R("body").removeClass("squared-signup-modal-active"),R("#squared-modal").removeClass("active").hide(),R("#squared-paywall-inline").length&&R("#squared-paywall-inline").hide()})}function w(){e.completedSubscriptionUrl&&R.post(e.completedSubscriptionUrl),squaredPaywall.ecommerceEvent({event:"ecomCheckout",ecommerce:{checkout:{actionField:{step:4,option:"Squared Inline"}}}},"/squared/inline-paywall-step-4"),e.purchaseInfoActionUrl&&R.get(e.purchaseInfoActionUrl,function(e){return e.success?void j({event:"ecomPurchase",ecommerce:{purchase:{actionField:{id:e.purchase_id,affiliation:"Greentech Media",revenue:e.purchase_amount,coupon:e.promo_code},products:[{name:T("name","Squared"),id:T("id","squared_product_inline_landing"),price:T("price"),brand:T("brand"),category:T("category","GTM Squared"),quantity:1,position:1}]}}},"/squared/complete"):void logMessage("SquaredPaywall - Failed to get purchase info")})}function _(){var t=e.checkoutModalActionUrl;e.planCode&&(t+="&plan_code="+e.planCode),C(t,function(){o("checkoutClosed",function(){logMessage("checkoutClosed"),a("checkoutClosed"),f()}),o("checkoutComplete",function(){logMessage("checkoutComplete"),a("checkoutComplete"),w()})})}function C(e,t){R.get(e,function(e){if(""!==e){if("refresh_page"===e)return void window.location.reload();var o=R(e);R("body").append(o),window.members_modal.activateModal(o,null),t&&t(R("#"+o.attr("id")))}})}function b(){_(),squaredPaywall.ecommerceEvent({event:"ecomCheckout",ecommerce:{checkout:{actionField:{step:3,option:"Squared Inline"}}}},"/squared/inline-paywall-step-3")}function M(t){F(function(){E(!1),R("#squared-paywall-inline").length||(R("body").addClass("squared-signup-modal-active"),R("#squared-modal").addClass("active").toggleClass("show-close-button",!e.modalPaywall),j({event:"ecomDetail",ecommerce:{detail:{actionField:{list:T("product_list")},products:[{name:T("name","Squared Homepage - Squared"),id:T("id",T("product_id_prefix")+"modal"),price:T("price"),brand:T("brand"),quantity:1,position:1}]}}},"/squared/paywall")),t!==!0&&R("#squared-paywall-inline").length||(R("body").addClass("squared-signup-modal-active"),R("#squared-modal").addClass("active").show().toggleClass("show-close-button",!e.modalPaywall))})}function S(){F(function(){R("#squared-modal").modal("show"),E(!0)})}function P(){if(e.planCode&&e.planTitle){var t=e.planTitle;F(function(){R(".squared-modal-block .squared-title").html(t),R("#squared-marketing-sidebar .squared-title").html(t)})}}function x(){F(function(){R("iframe[data-src]:not([src])").each(function(){var e=R(this);e.attr("src",e.data("src")),e.removeAttr("data-src")})})}function I(){m(),F(function(){E(!1),R("#squared-paywall-inline").length?document.location.reload(!0):R("#squared-modal").hasClass("in")&&R("#squared-modal").modal("hide")})}function U(){e.loggedIn&&R("body").hasClass("squared-enabled")&&e.articlePDFDownloadLinksUrl&&R.ajax(e.articlePDFDownloadLinksUrl).done(function(e){var t=JSON.parse(e);if(t&&t.download_link_href){var o=R(".download-article");o.find("a").attr("href",t.download_link_href),o.hasClass("hide-until-href")&&o.css("visibility","visible")}})}function F(e){"undefined"==typeof $jq?N.push(e):(null===R&&(R=$jq),R(e))}function D(){var e=setInterval(function(){"undefined"!=typeof $jq&&(null===R&&(R=$jq),R.each(N,function(e,t){R(t)}),clearInterval(e))},50)}function T(e,o){var n=getSquaredEcomDetailObject();return"undefined"!=typeof t&&"undefined"!=typeof t[e]?t[e]:"undefined"!=typeof t&&"undefined"!=typeof t["global:squared_ecomm_"+e]&&t["global:squared_ecomm_"+e]?(t[e]=t["global:squared_ecomm_"+e],t[e]):"undefined"!=typeof n&&"undefined"!=typeof n[e]?n[e]:R.cookie("gtm_squared_product_"+e)?(t[e]=R.cookie("gtm_squared_product_"+e),t[e]):"undefined"!=typeof o?o:void 0}function j(e,t){logMessage("SquaredPaywall - ecommerceEvent - "+JSON.stringify(e)),window.dataLayer=window.dataLayer||[],window.dataLayer.push(e),t&&window.dataLayer.push({event:"VirtualPageview",virtualPageURL:t,virtualPageTitle:document.title})}function E(e){if(e){R.cookie("gtm_squared_registering","yes",{expires:1,path:"/"});for(var t in window.dataLayer)if("ecomDetail"==dataLayer[t].event){var o=dataLayer[t].ecommerce.detail.products[0];o&&(R.cookie("gtm_squared_product_id",o.id,{expires:1,path:"/"}),R.cookie("gtm_squared_product_name",o.name,{expires:1,path:"/"}))}}else R.cookie("gtm_squared_registering",null,{expires:0,path:"/"})}function L(){window.location.href.match(/\/squared/)&&F(function(){R("header").on("click","#top-nav-signup, #top-nav-login, #secondary-nav-signup, #secondary-nav-login",function(e){e.preventDefault(),"top-nav-signup"==R(e.target).closest("a").attr("id")?R("#squared-modal-register-button").click():"top-nav-login"==R(e.target).closest("a").attr("id")&&R("#squared-modal-login-button").click(),R("#squared-paywall-inline").length>0?R("html, body").animate({scrollTop:R("#squared-paywall-inline").offset().top},500):M(!0)}),R(".squared-register-trigger").on("click",function(e){e.preventDefault(),R("#squared-paywall-inline").length>0?R("html, body").animate({scrollTop:R("#squared-paywall-inline").offset().top},500):M(!0)}),R(".squared-modal").on("click","button.close",function(e){e.preventDefault(),k()})})}var R=null;"undefined"==typeof window.tp&&(window.tp=[]);var O=this,A={planCode:null,planTitle:null,paywall:!1,entryId:null,loggedIn:!1,accountEligible:!1,registrationComplete:!1,email:null,userRef:null,contentCreated:null,completedSubscriptionUrl:null,articlePDFDownloadLinksUrl:null,existingSquaredUser:!1};e=s({},A,e);var N=[],$={};this.login=function(t,o,n,a){k(),e.loggedIn=!0,e.accountEligible=n,e.registrationComplete=a,r(o),c(t),h(),v(!0)},this.getUserRef=function(){return e.userRef},this.getEntryId=function(){return e.entryId},this.getEmail=function(){return e.email},this.getRid=function(){return e.rid},this.getOptions=function(){return e},this.getOption=function(t){return e[t]},this.on=o,this.off=n,this.trigger=i,this.ecommerceEvent=j,this.ecommerceVariable=T,this.toggleRegistrationInProgress=E,this.setAuthCookie=y,this.showModal=C,e.userRef&&c(e.userRef),e.contentCreated?(logMessage("SquaredPaywall - Content created: "+e.contentCreated),q(!1)):(logMessage("SquaredPaywall - No content created date"),q(!0)),P(),logMessage("SquaredPaywall - Startup"),e.inlinePaywall?(logMessage("SquaredPaywall - Inline paywall, checking status"),v()):"#checkout"===window.location.hash||e.modalPaywall?(logMessage("Checkout"),v()):e.existingSquaredUser?(logMessage("SquaredPaywall - Existing Squared user, checking access"),p()):!e.loggedIn&&e.planCode&&e.planTitle&&(logMessage("SquaredPaywall - Not logged in, showing offer: "+e.planTitle),S(),v()),e.email&&r(e.email),h(),L(),D()}function squaredCheckoutForm(e){function t(t){e(".squared-checkout-message").show().html(t),e(".members-modal__wrapper").animate({scrollTop:0})}function o(){e(".squared-checkout-message").hide()}function n(){var t=recurly.Pricing();t.on("set.plan",function(t){e(".squared-checkout-product-title").text(t.name),e(".squared-checkout-plan-duration").text(t.period.length+" "+t.period.interval),e(".squared-checkout-plan-price-symbol").text(t.price.USD.symbol),e(".squared-checkout-plan-price").text(t.price.USD.unit_amount)}),t.on("change",function(t){"0.00"===t.now.discount?(e(".squared-checkout-promo-discount").hide(),e(".squared-checkout-discounted-payment").hide()):(e(".squared-checkout-promo-discount").show(),e(".squared-checkout-discounted-payment").show())}),t.attach(document.querySelector(".squared-checkout-form"))}function a(e){var o=[],n={number:"Card number",month:"Card expiry month",year:"Card expiry year",postal_code:"ZIP Code",cvv:"CVV",address1:"address"};e.details.forEach(function(e){var t=n[e.field]||e.field;o.push(t+" "+e.messages.join(", ")),logMessage("showTokenValidationError: "+JSON.stringify(e))}),t(o.join("<br/>"))}function i(e,t){e?t.addClass("submitting"):t.removeClass("submitting")}function r(e){var t=!1,o=["country","address1","city","state"];return e.details.forEach(function(e){o.indexOf(e.field)!==-1&&(t=!0)}),t}function c(t){var o=t.find(".squared-checkout-payment");o.addClass("show-address-fields"),o.find(".squared-checkout-payment-address-field").each(function(){var t=e(this);t.attr("type","text")});var n=t.find(".squared-checkout-payment-country-field"),a=t.find(".country-override-field");jcf.replace(a),n.attr("data-recurly",null),a.attr("data-recurly","country")}function s(e){var t={plan_code:e.find('[name="plan_code"]').val(),checkout_token:e.find('[name="checkout_token"]').val(),postal_code:e.find('[name="postal_code"]').val(),coupon_code:e.find('[name="coupon_code"]').val(),auto_renew:e.find('[name="auto_renew"]').val(),update_address_on_success:"no"},o=e.find(".squared-checkout-payment"),n=o.hasClass("show-address-fields");return n&&(t.address1=e.find('[name="address1"]').val(),t.city=e.find('[name="city"]').val(),t.state=e.find('[name="state"]').val(),t.country=e.find('[name="country_override"]').val(),t.update_address_on_success="yes"),t}function l(){e("form.squared-checkout-form").on("submit",function(n){var l=this,d=e(l),u=d.find('[name="accept_terms"]').is(":checked");return n.preventDefault(),!d.hasClass("submitting")&&(o(),u?(i(!0,d),logMessage("squaredCheckoutForm: sending token request"),recurly.token(l,function(o,n){if(logMessage("squaredCheckoutForm: token response"),o)a(o),i(!1,d),r(o)&&c(d);else{logMessage("squaredCheckoutForm: token retrieved!",n);var u=squaredPaywall.getOption("processCheckoutUrl");if(!u)return logMessage("squaredCheckoutForm: No checkout URL defined"),void i(!1,d);var f=e(l).find('[name="plan_code"]').val(),g=s(d);$csrf_field=e(".squared-checkout-csrf-field"),g[$csrf_field.attr("name")]=$csrf_field.val(),e.post(u,g,function(e){if(i(!1,d),e.success){logMessage("squaredCheckoutForm: Closing modal"),window.members_modal.closeModal();var o=squaredPaywall.getOption("checkoutCompleteModalActionUrl");if(!o)return void logMessage("squaredCheckoutForm: No checkout URL defined");o+="&plan_code="+f,e.charged&&(o+="&charged=true"),logMessage("squaredCheckoutForm: Showing complete modal - "+o),squaredPaywall.showModal(o)}else t(e.errors.join("<br/>")),$csrf_field.val(e.csrf_token),e.address_fraud&&c(d)})}}),!1):(t("Please read and accept the terms of use"),!1))})}function d(){e(document).on("click",".squared-checkout-message",function(){o()})}function u(){e(document).on("click",".squared-checkout-promo-toggle",function(){e(this).closest(".squared-checkout-promo").toggleClass("enabled")})}logMessage("squaredCheckoutForm: Setting up recurly form"),setupRecurly({all:{style:{fontColor:"rgb(17, 17, 17)"}}}),n(),l(),d(),u()}function squaredCheckoutCompleteForm(e){function t(){var t=recurly.Pricing();t.on("set.plan",function(t){e(".squared-checkout-plan-name").text(t.name)}),t.attach(document.querySelector(".squared-checkout-purchase-info"))}function o(){e(".squared-checkout-close-button").on("click",function(){window.members_modal.closeModal(),squaredPaywall.trigger("checkoutClosed")})}t(),o(),squaredPaywall.trigger("checkoutComplete")}"undefined"==typeof window.logMessage;