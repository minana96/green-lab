---
title: "Critcal CSS energy analysis"
output: html_notebook
---

```{r}
library(ggplot2)
library(reshape)
library(e1071)
library(effsize)
library(dunn.test)
require(plyr)
require(gridExtra)
```

Let us first load all measures obtained from the experiment.

```{r}
# Get the measures (cpu load, memory usage, energy consumption and load time) for the specific browser (equal to folder name).
get_data <- function(browser_name) {
  subjects_path = paste("./data", browser_name, "data/nexus6p", sep="/")
  subjects <- list.dirs(subjects_path, full.names = FALSE, recursive = FALSE)
  data <- data.frame(
    name = character(),
    critical = logical(),
    energy_consumption = double(),
    time = integer(),
    memory_usage = integer(),
    cpu_usage = double(),
    stringsAsFactors = FALSE
  )

  for (subject in subjects) {
    # Obtain android measures (CPU usage)
    cpu_data <- data.frame(cpu_util = numeric())
    for (run_file in list.files(path = paste(subjects_path, subject, browser_name, "android", sep="/"), full.names = TRUE)[-1]) {
      android_results <- read.csv(run_file)
      cpu_data[nrow(cpu_data) + 1, ] <- c(mean(android_results$cpu))
    }

    # Obtain Trepn measures (time and memory usage)
    memory_data <- data.frame(mem_usage = numeric())
    time_data <- data.frame(time=numeric())
    for (run_file in list.files(path = paste(subjects_path, subject, browser_name, "trepn", sep="/"), full.names = TRUE)[-1]) {
      trepn_results <- read.csv(run_file)
      memory_data[nrow(memory_data) + 1, ] <- c(mean(trepn_results[, 2]))
      time_data[nrow(time_data) + 1, ] <- c(max(trepn_results[, 1]))
    }
    
    # Obtain Batterystats measures (energy consumption)
    energy_data <- data.frame(energy = numeric())
    for (run_file in list.files(path = paste(subjects_path, subject, browser_name, "batterystats", sep="/"), full.names = TRUE, pattern = "^Joule")) {
      batterystats_results <- read.csv(run_file)
      energy_data[nrow(energy_data) + 1, ] <- c(mean(batterystats_results[1, ]))
    }
    
    run_data <- data.frame(
      rep(strsplit(subject, "-")[[1]][2], nrow(energy_data)),
      rep(startsWith(subject, "subjects_critical"), nrow(energy_data)),
      energy_data,
      time_data,
      memory_data,
      cpu_data
    )
    names(run_data) <- names(data)
    data <- rbind(data, run_data)
  }

  return(data)
}

firefox_data <- get_data("firefox")
chrome_data <- get_data("chrome")
```

```{r}
#perform shapiro tests to check for normality. p-values lower than 0.05 are not normally distributed
print(firefox_data)
shapiro.test(firefox_data$energy_consumption)
shapiro.test(firefox_data$time)
shapiro.test(firefox_data$memory_usage)
shapiro.test(firefox_data$cpu_usage)
```

```{r}
#make qqplots of the data for additional verification (even though our sample size isn't small)
make_qqplot <- function(column, title, critical=TRUE) {
  qqnorm(column, main=paste("Normal Q-Q plot of", title, sep=" "))
  qqline(column, col = "blue")
}
make_qqplot(firefox_data[firefox_data$critical == TRUE,]$energy_consumption, "energy consumption for firefox (critical)", TRUE)
make_qqplot(firefox_data[firefox_data$critical == FALSE,]$energy_consumption, "energy consumption for firefox (non critical)", FALSE)

make_qqplot(firefox_data[firefox_data$critical == FALSE,]$cpu_usage, "CPU usage for firefox (non critical)", FALSE)
make_qqplot(firefox_data[firefox_data$critical == TRUE,]$cpu_usage, "CPU usage for firefox (critical)", TRUE)
```
```{r}
hist(firefox_data[firefox_data$critical == TRUE,]$energy_consumption, breaks=40, main="Histogram plot of energy consumption for firefox (critical)", xlab = "Energy consumption (J)")
hist(firefox_data[firefox_data$critical == FALSE,]$energy_consumption, breaks=100, main="Histogram plot of energy consumption for firefox (non critical)", xlab = "Energy consumption (J)")
hist(firefox_data[firefox_data$critical == TRUE,]$cpu_usage, breaks=30, main="Histogram plot of CPU usage for firefox (critical)", xlab = "CPU usage (%)")
hist(firefox_data[firefox_data$critical == TRUE,]$memory_usage, breaks=25, main="Histogram plot of memory usage for firefox (critical)", xlab = "Memory usage (kB)")

#perform wilcox test as the data is not normally distributed (at least not before applying transformations or removing outliers)
wilcox.test(firefox_data[firefox_data$critical == TRUE,]$energy_consumption, firefox_data[firefox_data$critical == FALSE,]$energy_consumption)
```


```{r}
print(chrome_data)
#perform shapiro tests to check for normality. p-values lower than 0.05 are not normally distributed
shapiro.test(chrome_data$energy_consumption)
shapiro.test(chrome_data$time)
shapiro.test(chrome_data$memory_usage)
shapiro.test(chrome_data$cpu_usage)
```

```{r}
make_qqplot(chrome_data[chrome_data$critical == TRUE,]$energy_consumption, "energy consumption for chrome (critical)")
make_qqplot(chrome_data[chrome_data$critical == FALSE,]$energy_consumption, "energy consumption for chrome (non critical)", FALSE)

make_qqplot(chrome_data[chrome_data$critical == FALSE,]$cpu_usage, "CPU usage for chrome (non critical)", FALSE)
make_qqplot(chrome_data[chrome_data$critical == TRUE,]$cpu_usage, "CPU usage for chrome (critical)", TRUE)
```

```{r}
hist(chrome_data[chrome_data$critical == TRUE,]$energy_consumption, breaks=40, main="Histogram plot of energy consumption for chrome (critical)", xlab = "Energy consumption (J)")
hist(chrome_data[chrome_data$critical == FALSE,]$energy_consumption, breaks=30, main="Histogram plot of energy consumption for chrome (non critical)", xlab = "Energy consumption (J)")
hist(chrome_data[chrome_data$critical == TRUE,]$cpu_usage, breaks=20, main="Histogram plot of CPU usage for chrome (critical)", xlab = "CPU usage (%)")
hist(chrome_data[chrome_data$critical == TRUE,]$memory_usage, breaks=25, main="Histogram plot of memory usage for chrome (critical)", xlab = "Memory usage (kB)")

#perform wilcox test as the data is not normally distributed (at least not before applying transformations or removing outliers)
wilcox.test(chrome_data[chrome_data$critical == TRUE,]$energy_consumption, chrome_data[chrome_data$critical == FALSE,]$energy_consumption)
```

