# Steps to configure experiment

This document gives an overview over the sequence of steps that you need to execute to replicate the Critical CSS experiment using your laptop and Android mobile device.

**Step 1**: Create a virtual environment called `venv` in the root folder of the repository. Make sure this is active from now on for any further interaction (`source venv/bin/activate`). Install all required python packages using `pip install -r requirements.txt`.

**Step 2**: Follow the Step 5 from instructions [here](https://github.com/S2-group/android-runner/blob/master/CONTRIBUTING.md) to install the dependencies of android-runner for your platform (Linux or Mac OS).

**Step 3**: Turn on `Developer Options` on your Android mobile device (detailed information depending on the Android version can be found [here](https://developer.android.com/studio/debug/dev-options)). Under `Developer Options`, turn on `USB debugging` and enable `Stay Awake` option.

**Step 4**: Plug in the mobile device to your laptop via USB and run `adb devices` command to start up a deamon. You should see the device's identifier. If not, unplug the USB cable and try again. If this does not solve the problem, try restarting the mobile device. 

**Step 5**: Add the device to the list in the `android_runner/devices.json` file by the format `<name>: <identifier>`. The `<indetifier>` is an output from the previous step whereas `<name>` should reflect the name of the device by your choice.

**Step 6**: Navigate to `android-runner/AndroidRunner/Plugins/trepn` and install Trepn Profiler on the mobile device by running `adb install com.quicinc.trepn.apk` command. You can verify that the Trepn is installed by running `adb shell pm list packages`. It will list all apks installed on the mobile device.

**Step 7**: Once installed, open the Trepn Profiler application on the mobile device and navigate to `Settings>>Data Points`. Verify that `Memory Usage` data point is dipsplayed witch means that this metric can be collected from the mobile device.

**Step 8**: Run `sudo apt install apktool` command to install [Apktool](https://github.com/iBotPeaches/Apktool). Make sure that the mobile device is connected via USB and run `adb devices` command to start up an adb client. Retrieve the `framework-res.apk` from your mobile device with `adb pull /system/framework/framework-res.apk ./` command. Run `apktool d framework-res.apk` command to extract `power_profile.xml` file. Make sure that the file is extracted with `cat framework-res/res/xml/power_profile.xml` command. The file is required for `batterystats` profiler which is used for energy consumption measurments. 

**Step 9**: Make sure that the mobile device is connected via USB and the adb client is started with `adb devices`. Navigate to `platform_tools/systrace` folder and run `python2 systrace.py -l` command. Verify that you can collect `freq` and `idle` from the mobile device in the output of the command.

**Step 10**: In the `android-runner/critical_css_experiment` folder, you can find two configuration scripts: one for the experiment on Chrome browser (`config_chrome.json`) and the other for Firefox (`config_firefox.json`). In both scripts, inside `devices` field, place the name of the device as you listed in `devices.json` file ([here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_chrome.json#L4) and [here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_firefox.json#L4)). Run `ip a` command to see your local IP adress and place it in the `local_server_address` field of both scrpts ([here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_chrome.json#L12) and [here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_firefox.json#L12)) by the format `http://<IP>:8000`. Finally, set the `powerprofile_path` field to either absolute or relative path to the extracted `power_profile.xml` file from the Step 8 ([here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_chrome.json#L65) and [here](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/config_firefox.json#L65)).

**Step 11**: In the `paths` field of the configuration scripts, you can see the paths to non-critical and critical versions of 50 web apps in the `subjects` folder that were used as subject of this experiments. A total of 25 web apps were assigned to each browser randomly. The critical versions were created using [Critical](https://github.com/addyosmani/critical) tool and the process is automated in the `android_runner/critical_css_experiment/Scripts/apply_critical.py` script. **TO DO: explain how to use the script and maybe add possibility to enter width and height as parameters**. 

**Step 12**: The `android_runner/critical_css_experiment/Scripts/add_get_on_load.py` script adds a custom `DOMContentLoaded` event listener into every subject. This listener sends an empty `Http GET` request that will be handled in `android_runner/critical_css_experiment/Scripts/interaction.py` script and the profiling will be stopped upon handling the request. You need to run this scrip before the experiment with the command `python3 add_get_on_load.py <path/To/Directory/With/All/WebApps/> <server_address>`. The first argument is a path to the folder with all subjects (when using the provided subjects, you can list the path to the `subjects` directory). The second argument is in the form of `http://<IP>:8001/` where `<IP>` is the local IP adress of your laptop.

**Step 13**: Clear the app data on both Firefox and Chrome browsers. This will be done after each run of the experiment in `android-runner` but not before the first run. You can do that either directly on the mobile device (go to `Settings>>Storage>>Other apps`, find Chrome and Firefox broswers and click `Clear storage` ) or programatically via adb (run commands `adb shell pm clear com.android.chrome` and `adb shell pm clear org.mozilla.firefox`).

**Step 14**: The `android_runner/critical_css_experiment/Scripts/after_launch.py` script will be run after a browser is launched but before a web app is loaded. Its purpose is to programatically tap buttons on the screen to remove the initial pop-up windows on Chrome browser which appear when the app data of Chrome is cleared before every run. If the pop-ups are not closed, a target web app will not be launched. The coordinates in [`chrome_launch`](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/Scripts/after_launch.py#L30) method are customized for Nexus6P mobile device and Chrome version `V85.0.4183.127`. Customize the method with the coordinates of your mobile device and your version of Chrome browser if needed. You can catch the cordinates by turning on the `Pointer location` option under the `Developer Options` on the phone. Open the cleared Chrome browser on the mobile device and you will see the (x, y) coordinates of the buttons that you need to tap. Tranfer the coordinates into the `after_launch` metod with one call of [`tap`](https://github.com/minana96/green-lab/blob/repo-organize/android_runner/critical_css_experiment/Scripts/after_launch.py#L21) method coresponding to one actual tap you performed to close all pop-ups. Do not forget to repeat Step 13 and clear Chrome app data again upon comletion of this step.

**Step 15**: Activate the virtual environment created in the Step 1 and navigate to the `green-lab` repository. The experiment can be started with `python3 android-runner <path_to_config_file>` command where `<path_to_config_file>` is `android-runner/critical_css_experiment/config_chrome.json` and `android-runner/critical_css_experiment/config_firefox.json` for Chrome and Firefox experiments respectfully. Make sure that brightness of the mobile device is set to minimum and that no app sends push notification during the experiment. The phone should be connected to the same Wi-Fi network as the laptop.

**Step 16**: You can stop the experiment any time by pressing any key on the keyboard. As the output, you will get the `--progress` parameter at the end which you can add next time you run the same configuration file to continue the experiment. You will continue where you left off. The adb deamon can be killed with `adb kill-server` upon finishing the experiment.


